# Makefile –¥–ª—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–Ω—è—Ç–∏—è –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É Kubernetes
# –ü—Ä–æ—Å—Ç–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Prometheus + Grafana + Loki

NAMESPACE = monitoring
DEMO_NAMESPACE = demo-app

.PHONY: help install-all install-prometheus install-loki install-demo clean clean-all status grafana-password port-forward-grafana port-forward-prometheus import-dashboard

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
help:
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "  install-all                - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ—Å—å —Å—Ç–µ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
	@echo "  install-prometheus         - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Prometheus + Grafana"
	@echo "  install-loki               - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Loki –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"
	@echo "  install-demo               - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–º–æ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
	@echo "  status                     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"
	@echo "  grafana-password           - –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è Grafana"
	@echo "  port-forward-grafana       - –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Ä—Ç-—Ñ–æ—Ä–≤–∞—Ä–¥ –¥–ª—è Grafana"
	@echo "  port-forward-prometheus    - –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Ä—Ç-—Ñ–æ—Ä–≤–∞—Ä–¥ –¥–ª—è Prometheus"
	@echo "  import-dashboard           - –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏–º–ø–æ—Ä—Ç—É –¥–∞—à–±–æ—Ä–¥–∞"
	@echo "  clean                      - –£–¥–∞–ª–∏—Ç—å –¥–µ–º–æ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
	@echo "  clean-all                  - –£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å —Å—Ç–µ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
	@echo ""

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ—Å—å —Å—Ç–µ–∫
install-all: install-prometheus install-loki install-demo
	@echo "–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!"
	@echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ 'make grafana-password' —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è Grafana"
	@echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ 'make port-forward-grafana' –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Grafana"

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Helm —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
setup-helm:
	@echo "–î–æ–±–∞–≤–ª—è–µ–º Helm —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏..."
	helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
	helm repo add grafana https://grafana.github.io/helm-charts
	helm repo update
	@echo "Helm —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Prometheus + Grafana
install-prometheus: setup-helm
	@echo "üöÄ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Prometheus Stack..."
	kubectl create namespace $(NAMESPACE) --dry-run=client -o yaml | kubectl apply -f -
	helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
		--namespace $(NAMESPACE) \
		--values values-prometheus.yaml \
		--wait
	@echo "Prometheus Stack —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Loki –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
install-loki: setup-helm
	@echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Loki Stack..."
	helm upgrade --install loki grafana/loki-stack \
		--namespace $(NAMESPACE) \
		--set grafana.enabled=false \
		--set prometheus.enabled=false \
		--set loki.persistence.enabled=true \
		--set loki.persistence.size=10Gi \
		--wait
	@echo "Loki Stack —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
	@echo "Loki –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –≤ Grafana"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ–º–æ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
install-demo:
	@echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ–º–æ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
	kubectl create namespace $(DEMO_NAMESPACE) --dry-run=client -o yaml | kubectl apply -f -
	kubectl apply -f demo-app/
	@echo "–î–µ–º–æ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
	@echo "–î–∞—à–±–æ—Ä–¥ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª–µ dashboards/demo-app-dashboard.json"
	@echo "–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ –≤ Grafana: Dashboard ‚Üí Import ‚Üí Upload JSON file"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
status:
	@echo "=== –°—Ç–∞—Ç—É—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ ==="
	@echo ""
	@echo "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ namespace:"
	kubectl get pods -n $(NAMESPACE)
	@echo ""
	@echo "–î–µ–º–æ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ namespace:"
	kubectl get pods -n $(DEMO_NAMESPACE)
	@echo ""
	@echo "–°–µ—Ä–≤–∏—Å—ã:"
	kubectl get svc -n $(NAMESPACE)

# –ü–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è Grafana
grafana-password:
	@echo "–ü–∞—Ä–æ–ª—å –¥–ª—è Grafana (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: admin):"
	@kubectl get secret -n $(NAMESPACE) monitoring-grafana -o jsonpath="{.data.admin-password}" | base64 --decode
	@echo ""

# –ü–æ—Ä—Ç-—Ñ–æ—Ä–≤–∞—Ä–¥ –¥–ª—è Grafana
port-forward-grafana:
	@echo "–ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ä—Ç-—Ñ–æ—Ä–≤–∞—Ä–¥ –¥–ª—è Grafana..."
	@echo "Grafana –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:3000"
	@echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: admin"
	@make grafana-password
	kubectl port-forward -n $(NAMESPACE) svc/monitoring-grafana 3000:80

# –ü–æ—Ä—Ç-—Ñ–æ—Ä–≤–∞—Ä–¥ –¥–ª—è Prometheus
port-forward-prometheus:
	@echo "–ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ä—Ç-—Ñ–æ—Ä–≤–∞—Ä–¥ –¥–ª—è Prometheus..."
	@echo "Prometheus –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:9090"
	kubectl port-forward -n $(NAMESPACE) svc/monitoring-kube-prometheus-prometheus 9090:9090

# –£–¥–∞–ª–∏—Ç—å –¥–µ–º–æ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
clean:
	@echo "–£–¥–∞–ª—è–µ–º –¥–µ–º–æ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
	kubectl delete namespace $(DEMO_NAMESPACE) --ignore-not-found=true
	@echo "–î–µ–º–æ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ"

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏–º–ø–æ—Ä—Ç—É –¥–∞—à–±–æ—Ä–¥–∞
import-dashboard:
	@echo "–ö–∞–∫ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ –≤ Grafana:"
	@echo ""
	@echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ Grafana: http://localhost:3000"
	@echo "2. –í–æ–π–¥–∏—Ç–µ: admin / otus123"
	@echo "3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤: Dashboard ‚Üí Import"
	@echo "4. –ù–∞–∂–º–∏—Ç–µ 'Upload JSON file'"
	@echo "5. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª: dashboards/demo-app-dashboard.json"
	@echo "6. –ù–∞–∂–º–∏—Ç–µ 'Import'"
	@echo ""
	@echo "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ:"
	@echo "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ dashboards/demo-app-dashboard.json"
	@echo "–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ –ø–æ–ª–µ 'Import via panel json'"

# –£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å —Å—Ç–µ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
clean-all:
	@echo "–£–¥–∞–ª—è–µ–º –≤–µ—Å—å —Å—Ç–µ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
	helm uninstall monitoring -n $(NAMESPACE) --ignore-not-found
	helm uninstall loki -n $(NAMESPACE) --ignore-not-found
	kubectl delete namespace $(NAMESPACE) --ignore-not-found=true
	kubectl delete namespace $(DEMO_NAMESPACE) --ignore-not-found=true
	@echo "–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É–¥–∞–ª–µ–Ω—ã"
